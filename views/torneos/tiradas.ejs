<div class="container mt-4 mb-5">
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card shadow">
        <div class="card-header bg-success text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="h4 mb-0">
              <i class="fas fa-bullseye me-2"></i> Registro de Tiradas - <%= torneo.nombre %>
            </h2>
            <span class="badge bg-light text-success">Ronda <%= rondaActual %> de <%= torneo.rondas %></span>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Fecha:</strong> <%= new Date(torneo.fecha).toLocaleDateString('es-ES') %></p>
              <p><strong>Flechas por tirada:</strong> <%= torneo.flechasPorTirada %></p>
            </div>
            <div class="col-md-6">
              <p><strong>Rondas totales:</strong> <%= torneo.rondas %></p>
              <p><strong>Participantes:</strong> <%= torneo.participantes.filter(p => p.estado === 'aceptado').length %></p>
            </div>
          </div>
          
          <!-- Información del estado del usuario -->
          <% if (esCreador) { %>
            <div class="alert alert-info">
              <strong><i class="fas fa-crown me-2"></i> Eres el creador de este torneo.</strong>
              Puedes registrar tiradas para todos los participantes.
            </div>
          <% } else { %>
            <div class="alert alert-warning">
              <strong><i class="fas fa-info-circle me-2"></i> Participante</strong>
              Solo el creador del torneo puede registrar tiradas.
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <% if (esCreador) { %>
      <div class="col-12 mb-4">
        <ul class="nav nav-tabs" id="torneoTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro" 
                    type="button" role="tab" aria-controls="registro" aria-selected="true">
              <i class="fas fa-edit me-1"></i> Registrar Tiradas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tiradas-tab" data-bs-toggle="tab" data-bs-target="#tiradas" 
                    type="button" role="tab" aria-controls="tiradas" aria-selected="false">
              <i class="fas fa-clipboard-list me-1"></i> Tiradas Registradas
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="clasificacion-tab" data-bs-toggle="tab" data-bs-target="#clasificacion" 
                    type="button" role="tab" aria-controls="clasificacion" aria-selected="false">
              <i class="fas fa-trophy me-1"></i> Clasificación
            </button>
          </li>
        </ul>
        
        <div class="tab-content card shadow border-top-0" id="torneoTabContent">
          <!-- PESTAÑA 1: REGISTRO DE TIRADAS -->
          <div class="tab-pane fade show active p-3" id="registro" role="tabpanel" aria-labelledby="registro-tab">
            <% 
              // Filtrar participantes aceptados que no han registrado tirada para esta ronda
              const participantesDisponibles = torneo.participantes
                .filter(p => p.estado === 'aceptado' && 
                            (!p.tiradas || !p.tiradas.some(t => t.ronda === rondaActual)));
            %>
            
            <% if (participantesDisponibles.length === 0) { %>
              <div class="alert alert-success mb-4">
                <i class="fas fa-check-circle me-2"></i>
                <strong>¡Ronda completa!</strong> Todos los participantes han registrado sus tiradas para la ronda <%= rondaActual %>.
                <% if (rondaActual < torneo.rondas) { %>
                  <div class="mt-2">
                    <strong>El sistema avanzará automáticamente a la siguiente ronda cuando recargues la página.</strong>
                  </div>
                <% } else { %>
                  <div class="mt-2">
                    <strong>Esta es la última ronda del torneo. Puedes finalizarlo cuando estés listo.</strong>
                  </div>
                <% } %>
              </div>
            <% } else { %>
              <div class="card mb-4">
                <div class="card-header bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <h3 class="h5 mb-0">Participantes pendientes (<%= participantesDisponibles.length %>)</h3>
                    
                    <!-- Buscador de participantes -->
                    <div class="input-group" style="max-width: 300px;">
                      <input type="text" id="buscarParticipante" class="form-control" placeholder="Buscar arquero..." aria-label="Buscar participante">
                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <!-- Vista para escritorio -->
                  <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover mb-0" id="tablaParticipantesPendientes">
                      <thead class="table-light">
                        <tr>
                          <th>Arquero</th>
                          <th>Tipo de Arco</th>
                          <th>Puntuación Actual</th>
                          <th>Tiradas Completadas</th>
                          <th>Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% participantesDisponibles.forEach(participante => { %>
                          <tr class="participante-row">
                            <td>
                              <div class="d-flex align-items-center">
                                <span class="fw-bold"><%= participante.usuario.nombre %> <%= participante.usuario.apellido %></span>
                              </div>
                            </td>
                            <td><%= participante.usuario.tipoArco || '-' %></td>
                            <td><%= participante.puntuacion %></td>
                            <td><%= participante.tiradas ? participante.tiradas.length : 0 %> / <%= torneo.rondas %></td>
                            <td>
                              <button 
                                class="btn btn-sm btn-success registrar-btn" 
                                data-participante-id="<%= participante.usuario._id %>"
                                data-participante-nombre="<%= participante.usuario.nombre %> <%= participante.usuario.apellido %>">
                                <i class="fas fa-edit me-1"></i> Registrar
                              </button>
                            </td>
                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                  
                  <!-- Vista optimizada para móvil: Lista de tarjetas -->
                  <div class="d-md-none">
                    <div class="list-group list-group-flush">
                      <% participantesDisponibles.forEach(participante => { %>
                        <div class="list-group-item participante-row">
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <h5 class="mb-1"><%= participante.usuario.nombre %> <%= participante.usuario.apellido %></h5>
                              <p class="mb-1 small text-muted">
                                <span class="badge bg-light text-dark border"><%= participante.usuario.tipoArco || 'Sin arco' %></span>
                                <span class="ms-2"><%= participante.tiradas ? participante.tiradas.length : 0 %> / <%= torneo.rondas %> rondas</span>
                              </p>
                            </div>
                            <button 
                              class="btn btn-success registrar-btn" 
                              data-participante-id="<%= participante.usuario._id %>"
                              data-participante-nombre="<%= participante.usuario.nombre %> <%= participante.usuario.apellido %>">
                              <i class="fas fa-edit me-1"></i> Registrar
                            </button>
                          </div>
                        </div>
                      <% }); %>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Formulario de registro de tiradas (inicialmente oculto) -->
              <div id="registroTiradaForm" class="card border-success mb-4" style="display: none;">
                <div class="card-header bg-success text-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h3 class="h5 mb-0">
                      <i class="fas fa-arrow-alt-circle-right me-2"></i> 
                      <span id="nombreParticipanteSeleccionado"></span>
                    </h3>
                    <button type="button" id="cancelarRegistroBtn" class="btn-close btn-close-white"></button>
                  </div>
                </div>
                <div class="card-body">
                  <form action="/torneos/<%= torneo._id %>/registrar-tirada" method="POST" class="needs-validation" novalidate>
                    <input type="hidden" name="ronda" value="<%= rondaActual %>">
                    <input type="hidden" name="participanteId" id="participanteIdInput" value="">
                    
                    <!-- Campos para puntuaciones - NUEVO DISEÑO MÓVIL OPTIMIZADO -->
                    <div class="row mb-3">
                      <div class="col-12">
                        <div class="card">
                          <div class="card-header bg-light">
                            <h4 class="mb-0"><i class="fas fa-arrows-alt me-2"></i> Selección de flechas</h4>
                          </div>
                          <div class="card-body">
                            <!-- Vista móvil - Selector de flecha con carrusel -->
                            <div class="d-md-none">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <button type="button" class="btn btn-sm btn-secondary" id="prevFlechaBtn">
                                  <i class="fas fa-arrow-left"></i>
                                </button>
                                <div class="text-center">
                                  <h5 class="mb-0">Flecha <span id="flechaActualMobile">1</span> de <%= torneo.flechasPorTirada %></h5>
                                  <div class="mt-2">
                                    <span id="valorFlechaMobile" class="display-1 fw-bold">-</span>
                                  </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-secondary" id="nextFlechaBtn">
                                  <i class="fas fa-arrow-right"></i>
                                </button>
                              </div>
                              
                              <!-- Indicadores de flechas -->
                              <div class="d-flex justify-content-center mb-3">
                                <% for(let i = 0; i < torneo.flechasPorTirada; i++) { %>
                                  <div class="flecha-indicator mx-1" data-flecha="<%= i %>">
                                    <span class="badge rounded-pill bg-secondary">
                                      <%= i+1 %>
                                    </span>
                                  </div>
                                <% } %>
                              </div>
                              
                              <!-- Botonera de puntuación móvil (siempre visible) -->
                              <div class="botonera-mobile">
                                <!-- 9-10: fondo amarillo con letras en negro -->
                                <div class="d-flex mb-2 justify-content-between">
                                  <% for(let j = 10; j >= 9; j--) { %>
                                    <button type="button" 
                                        class="btn punto-btn-mobile btn-lg btn-warning text-dark" 
                                        style="width: 48%"
                                        data-punto="<%= j %>">
                                      <%= j %>
                                    </button>
                                  <% } %>
                                </div>
                                
                                <!-- 7-8: fondo rojo letras negro -->
                                <div class="d-flex mb-2 justify-content-between">
                                  <% for(let j = 8; j >= 7; j--) { %>
                                    <button type="button" 
                                        class="btn punto-btn-mobile btn-lg btn-danger text-dark" 
                                        style="width: 48%"
                                        data-punto="<%= j %>">
                                      <%= j %>
                                    </button>
                                  <% } %>
                                </div>
                                
                                <!-- 5-6: fondo celeste letras en negro -->
                                <div class="d-flex mb-2 justify-content-between">
                                  <% for(let j = 6; j >= 5; j--) { %>
                                    <button type="button" 
                                        class="btn punto-btn-mobile btn-lg btn-info text-dark" 
                                        style="width: 48%"
                                        data-punto="<%= j %>">
                                      <%= j %>
                                    </button>
                                  <% } %>
                                </div>
                                
                                <!-- 3-4: fondo negro con letras blancas -->
                                <div class="d-flex mb-2 justify-content-between">
                                  <% for(let j = 4; j >= 3; j--) { %>
                                    <button type="button" 
                                        class="btn punto-btn-mobile btn-lg btn-dark text-white" 
                                        style="width: 48%"
                                        data-punto="<%= j %>">
                                      <%= j %>
                                    </button>
                                  <% } %>
                                </div>
                                
                                <!-- 0-2: fondo blanco con letra negra -->
                                <div class="d-flex justify-content-between">
                                  <% for(let j = 2; j >= 0; j--) { %>
                                    <button type="button" 
                                        class="btn punto-btn-mobile btn-lg btn-outline-dark" 
                                        style="width: 31%"
                                        data-punto="<%= j %>">
                                      <%= j %>
                                    </button>
                                  <% } %>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Vista escritorio - Todas las flechas -->
                            <div class="row flechas-selector d-none d-md-flex">
                              <% for(let i = 0; i < torneo.flechasPorTirada; i++) { %>
                                <div class="col-md-4 col-lg-3 mb-2">
                                  <button type="button" 
                                      class="btn btn-outline-primary btn-flecha w-100" 
                                      data-flecha="<%= i %>"
                                      id="btnFlecha<%= i %>">
                                    <span class="numero-flecha">Flecha <%= i+1 %></span>
                                    <span class="valor-flecha badge bg-secondary d-none">-</span>
                                  </button>
                                </div>
                              <% } %>
                            </div>

                            <!-- Contenedor de botonera para escritorio (aparece solo cuando se selecciona una flecha) -->
                            <div id="botoneraContainer" class="mt-3 d-none d-md-block d-none">
                              <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                  <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Puntuación: <span id="flechaSeleccionadaText">Flecha 1</span></h5>
                                    <button type="button" class="btn-close btn-close-white" id="cerrarBotonera" aria-label="Cerrar"></button>
                                  </div>
                                </div>
                                <div class="card-body p-2">
                                  <!-- 0-2: fondo blanco con letra negra -->
                                  <div class="d-flex mb-2 justify-content-between">
                                    <% for(let j = 0; j <= 2; j++) { %>
                                      <button type="button" 
                                          class="btn punto-btn btn-lg btn-outline-dark" 
                                          style="width: 31%"
                                          data-punto="<%= j %>">
                                        <%= j %>
                                      </button>
                                    <% } %>
                                  </div>
                                  
                                  <!-- 3-4: fondo negro con letras blancas -->
                                  <div class="d-flex mb-2 justify-content-between">
                                    <% for(let j = 3; j <= 4; j++) { %>
                                      <button type="button" 
                                          class="btn punto-btn btn-lg btn-dark text-white" 
                                          style="width: 48%"
                                          data-punto="<%= j %>">
                                        <%= j %>
                                      </button>
                                    <% } %>
                                  </div>
                                  
                                  <!-- 5-6: fondo celeste letras en negro -->
                                  <div class="d-flex mb-2 justify-content-between">
                                    <% for(let j = 5; j <= 6; j++) { %>
                                      <button type="button" 
                                          class="btn punto-btn btn-lg btn-info text-dark" 
                                          style="width: 48%"
                                          data-punto="<%= j %>">
                                        <%= j %>
                                      </button>
                                    <% } %>
                                  </div>
                                  
                                  <!-- 7-8: fondo rojo letras negro -->
                                  <div class="d-flex mb-2 justify-content-between">
                                    <% for(let j = 7; j <= 8; j++) { %>
                                      <button type="button" 
                                          class="btn punto-btn btn-lg btn-danger text-dark" 
                                          style="width: 48%"
                                          data-punto="<%= j %>">
                                        <%= j %>
                                      </button>
                                    <% } %>
                                  </div>
                                  
                                  <!-- 9-10: fondo amarillo con letras en negro -->
                                  <div class="d-flex justify-content-between">
                                    <% for(let j = 9; j <= 10; j++) { %>
                                      <button type="button" 
                                          class="btn punto-btn btn-lg btn-warning text-dark" 
                                          style="width: 48%"
                                          data-punto="<%= j %>">
                                        <%= j %>
                                      </button>
                                    <% } %>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            <!-- Inputs ocultos para todos los valores -->
                            <% for(let i = 0; i < torneo.flechasPorTirada; i++) { %>
                              <input type="hidden" name="puntos[<%= i %>]" id="puntoInput<%= i %>" required value="">
                            <% } %>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Botón de guardar -->
                    <div class="d-md-flex justify-content-end d-none">
                      <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save me-2"></i> Guardar tirada
                      </button>
                    </div>
                    
                    <!-- Botón para móvil -->
                    <div class="d-md-none mb-3">
                      <button type="submit" class="btn btn-success btn-lg w-100 py-3">
                        <i class="fas fa-save me-2"></i> Guardar tirada
                      </button>
                    </div>
                    
                    <!-- Resumen de puntuación compacto -->
                    <div class="card">
                      <div class="card-body py-2">
                        <div class="d-flex align-items-center justify-content-between">
                          <div class="d-flex align-items-center gap-2">
                            <% for(let i = 0; i < torneo.flechasPorTirada; i++) { %>
                              <div class="text-center">
                                <div class="badge bg-light text-dark border" style="min-width: 30px;" id="resumenFlecha<%= i %>">-</div>
                                <div class="small text-muted" style="font-size: 0.7rem;">F<%= i+1 %></div>
                              </div>
                            <% } %>
                          </div>
                          <div class="ms-3 d-flex align-items-center">
                            <span class="text-muted me-2">Total:</span>
                            <span id="puntuacion-total" class="badge bg-success fs-5">0</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            <% } %>
          </div>
          
          <!-- PESTAÑA 2: TIRADAS REGISTRADAS -->
          <div class="tab-pane fade p-3" id="tiradas" role="tabpanel" aria-labelledby="tiradas-tab">
            <% 
              // Obtener participantes con tiradas en la ronda actual
              const participantesConTirada = torneo.participantes
                .filter(p => p.estado === 'aceptado' && 
                          p.tiradas && p.tiradas.some(t => t.ronda === rondaActual));
            %>
            
            <div class="card mb-4">
              <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <h3 class="h5 mb-0">Tiradas registradas - Ronda <%= rondaActual %></h3>
                  <span class="badge bg-primary"><%= participantesConTirada.length %> de <%= torneo.participantes.filter(p => p.estado === 'aceptado').length %></span>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-bordered table-striped mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Arquero</th>
                        <% for(let i = 1; i <= torneo.flechasPorTirada; i++) { %>
                          <th class="text-center">F<%= i %></th>
                        <% } %>
                        <th class="text-center">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (participantesConTirada.length === 0) { %>
                        <tr>
                          <td colspan="<%= torneo.flechasPorTirada + 2 %>" class="text-center py-3">
                            <i class="fas fa-info-circle me-2"></i> No hay tiradas registradas para esta ronda
                          </td>
                        </tr>
                      <% } else { %>
                        <% participantesConTirada.forEach(participante => { %>
                          <tr>
                            <td>
                              <%= participante.usuario.nombre %> <%= participante.usuario.apellido %>
                            </td>
                            <% 
                              const tiradaActual = participante.tiradas.find(t => t.ronda === rondaActual);
                            %>
                            <% tiradaActual.puntos.forEach(punto => { %>
                              <td class="text-center <%= punto >= 8 ? 'table-success' : punto >= 5 ? 'table-warning' : 'table-danger' %>">
                                <strong><%= punto %></strong>
                              </td>
                            <% }); %>
                            <td class="text-center table-primary">
                              <strong><%= tiradaActual.total %></strong>
                            </td>
                          </tr>
                        <% }); %>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Historial de rondas anteriores (colapsable) -->
            <% if (rondaActual > 1) { %>
              <div class="accordion mb-4" id="accordionRondas">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingRondas">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapseRondas" aria-expanded="false" aria-controls="collapseRondas">
                      <i class="fas fa-history me-2"></i> Historial de rondas anteriores
                    </button>
                  </h2>
                  <div id="collapseRondas" class="accordion-collapse collapse" aria-labelledby="headingRondas">
                    <div class="accordion-body p-0">
                      <% for(let r = rondaActual - 1; r >= 1; r--) { %>
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <h5 class="mb-0">Ronda <%= r %></h5>
                          </div>
                          <div class="card-body p-0">
                            <div class="table-responsive">
                              <table class="table table-bordered table-striped mb-0">
                                <thead class="table-light">
                                  <tr>
                                    <th>Arquero</th>
                                    <% for(let i = 1; i <= torneo.flechasPorTirada; i++) { %>
                                      <th class="text-center">F<%= i %></th>
                                    <% } %>
                                    <th class="text-center">Total</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <% 
                                    const tiradasPorRonda = torneo.participantes
                                      .filter(p => p.estado === 'aceptado' && 
                                              p.tiradas && p.tiradas.some(t => t.ronda === r));
                                  %>
                                  <% if (tiradasPorRonda.length === 0) { %>
                                    <tr>
                                      <td colspan="<%= torneo.flechasPorTirada + 2 %>" class="text-center">
                                        No hay tiradas registradas para esta ronda
                                      </td>
                                    </tr>
                                  <% } else { %>
                                    <% tiradasPorRonda.forEach(participante => { %>
                                      <tr>
                                        <td>
                                          <%= participante.usuario.nombre %> <%= participante.usuario.apellido %>
                                        </td>
                                        <% 
                                          const tirada = participante.tiradas.find(t => t.ronda === r);
                                        %>
                                        <% tirada.puntos.forEach(punto => { %>
                                          <td class="text-center <%= punto >= 8 ? 'table-success' : punto >= 5 ? 'table-warning' : 'table-danger' %>">
                                            <strong><%= punto %></strong>
                                          </td>
                                        <% }); %>
                                        <td class="text-center table-primary">
                                          <strong><%= tirada.total %></strong>
                                        </td>
                                      </tr>
                                    <% }); %>
                                  <% } %>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
          
          <!-- PESTAÑA 3: CLASIFICACIÓN GENERAL -->
          <div class="tab-pane fade p-3" id="clasificacion" role="tabpanel" aria-labelledby="clasificacion-tab">
            <% 
              // Ordenar participantes por puntuación (de mayor a menor)
              const participantesOrdenados = torneo.participantes
                .filter(p => p.estado === 'aceptado')
                .sort((a, b) => b.puntuacion - a.puntuacion);
            %>
            
            <div class="card">
              <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                  <h3 class="h5 mb-0">Clasificación General</h3>
                  <div class="input-group" style="max-width: 300px;">
                    <input type="text" id="buscarClasificacion" class="form-control" placeholder="Buscar arquero..." aria-label="Buscar en clasificación">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-striped table-hover mb-0" id="tablaClasificacion">
                    <thead class="table-light">
                      <tr>
                        <th>#</th>
                        <th>Arquero</th>
                        <th>Tipo de Arco</th>
                        <th>Puntuación Total</th>
                        <th>Rondas Completadas</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% participantesOrdenados.forEach((participante, index) => { %>
                        <tr class="clasificacion-row <%= participante.usuario && participante.usuario._id.toString() === userId ? 'table-primary' : '' %>">
                          <td><%= index + 1 %></td>
                          <td>
                            <div class="d-flex align-items-center">
                              <%= participante.usuario ? `${participante.usuario.nombre} ${participante.usuario.apellido}` : 'Desconocido' %>
                              <% if (index === 0 && participantesOrdenados.length > 1) { %>
                                <i class="fas fa-trophy text-warning ms-2"></i>
                              <% } %>
                            </div>
                          </td>
                          <td><%= participante.usuario ? participante.usuario.tipoArco : '-' %></td>
                          <td><strong><%= participante.puntuacion %></strong></td>
                          <td><%= participante.tiradas ? participante.tiradas.length : 0 %> / <%= torneo.rondas %></td>
                          <td>
                            <a href="/torneos/<%= torneo._id %>/participante/<%= participante.usuario._id %>/detalle" 
                               class="btn btn-sm btn-outline-info">
                              <i class="fas fa-chart-line"></i>
                            </a>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } else { %>
      <!-- Vista para no creadores: Solo pueden ver la clasificación -->
      <div class="col-md-12 mb-4">
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            <h3 class="h5 mb-0"><i class="fas fa-table me-2"></i> Clasificación General</h3>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Arquero</th>
                    <th>Tipo de Arco</th>
                    <th>Puntuación Total</th>
                    <th>Rondas Completadas</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <% 
                    // Ordenar participantes por puntuación (de mayor a menor)
                    const participantesOrdenados = torneo.participantes
                      .filter(p => p.estado === 'aceptado')
                      .sort((a, b) => b.puntuacion - a.puntuacion);
                  %>
                  <% participantesOrdenados.forEach((participante, index) => { %>
                    <tr class="<%= participante.usuario && participante.usuario._id.toString() === userId ? 'table-primary' : '' %>">
                      <td><%= index + 1 %></td>
                      <td>
                        <%= participante.usuario ? `${participante.usuario.nombre} ${participante.usuario.apellido}` : 'Desconocido' %>
                        <% if (index === 0 && participantesOrdenados.length > 1) { %>
                          <i class="fas fa-trophy text-warning ms-2"></i>
                        <% } %>
                      </td>
                      <td><%= participante.usuario ? participante.usuario.tipoArco : '-' %></td>
                      <td><strong><%= participante.puntuacion %></strong></td>
                      <td><%= participante.tiradas ? participante.tiradas.length : 0 %> / <%= torneo.rondas %></td>
                      <td>
                        <a href="/torneos/<%= torneo._id %>/participante/<%= participante.usuario._id %>/detalle" 
                           class="btn btn-sm btn-outline-info">
                          <i class="fas fa-chart-line"></i>
                        </a>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <div class="col-12 d-flex justify-content-between mb-5">
      <a href="/torneos/<%= torneo._id %>" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i> Volver al Torneo
      </a>
      <% if (esCreador && esUltimaRonda && todasLasTiradasRegistradas) { %>
        <a href="/torneos/<%= torneo._id %>/finalizar" 
           class="btn btn-danger"
           onclick="return confirm('¿Estás seguro de que deseas finalizar el torneo? Esta acción no se puede deshacer.')">
          <i class="fas fa-flag-checkered me-2"></i> Finalizar Torneo
        </a>
      <% } %>
    </div>

    <div class="d-flex justify-content-between mb-3">
      <h3 class="h5"><i class="fas fa-list-ol me-2"></i> Clasificación Actual</h3>
      <a href="/torneos/<%= torneo._id %>/clasificacion" class="btn btn-sm btn-outline-primary">
        <i class="fas fa-trophy me-1"></i> Ver Clasificación Completa
      </a>
    </div>
  </div>
</div>

<div class="d-sm-none">
  <a href="/dashboard" class="btn btn-primary mobile-float-btn">
    <i class="fas fa-home"></i>
  </a>
</div>

<script>
  // Script para gestionar la interfaz de registro
  document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const buscarParticipanteInput = document.getElementById('buscarParticipante');
    const buscarClasificacionInput = document.getElementById('buscarClasificacion');
    const participanteRows = document.querySelectorAll('.participante-row');
    const clasificacionRows = document.querySelectorAll('.clasificacion-row');
    const registrarBtns = document.querySelectorAll('.registrar-btn');
    const registroForm = document.getElementById('registroTiradaForm');
    const participanteIdInput = document.getElementById('participanteIdInput');
    const nombreParticipanteSpan = document.getElementById('nombreParticipanteSeleccionado');
    const cancelarBtn = document.getElementById('cancelarRegistroBtn');
    const puntuacionInputs = document.querySelectorAll('input[name^="puntos["]');
    const puntuacionTotalSpan = document.getElementById('puntuacion-total');
    
    // Elementos específicos del nuevo diseño
    const btnsFlechas = document.querySelectorAll('.btn-flecha');
    const botoneraContainer = document.getElementById('botoneraContainer');
    const btnsPuntos = document.querySelectorAll('.punto-btn');
    const cerrarBotonera = document.getElementById('cerrarBotonera');
    const flechaSeleccionadaText = document.getElementById('flechaSeleccionadaText');
    
    let flechaSeleccionadaIndice = null;
    
    // Variables para la nueva interfaz móvil
    const prevFlechaBtn = document.getElementById('prevFlechaBtn');
    const nextFlechaBtn = document.getElementById('nextFlechaBtn');
    const flechaActualMobile = document.getElementById('flechaActualMobile');
    const valorFlechaMobile = document.getElementById('valorFlechaMobile');
    const flechaIndicators = document.querySelectorAll('.flecha-indicator');
    const puntoBtnsMobile = document.querySelectorAll('.punto-btn-mobile');
    const resumenFlechas = [];
    
    // Inicializar array de resumen
    for(let i = 0; i < <%= torneo.flechasPorTirada %>; i++) {
      resumenFlechas.push(document.getElementById(`resumenFlecha${i}`));
    }
    
    // Variable para seguimiento de la flecha actual en móvil
    let flechaActivaIdx = 0;
    
    // Función de búsqueda para participantes pendientes
    if (buscarParticipanteInput) {
      buscarParticipanteInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        participanteRows.forEach(row => {
          const nombre = row.querySelector('td:first-child').textContent.toLowerCase();
          if (nombre.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
    }
    
    // Función de búsqueda para clasificación
    if (buscarClasificacionInput) {
      buscarClasificacionInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        clasificacionRows.forEach(row => {
          const nombre = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
          if (nombre.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
    }
    
    // Mostrar formulario de registro al hacer clic en "Registrar"
    if (registrarBtns) {
      registrarBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const participanteId = this.getAttribute('data-participante-id');
          const participanteNombre = this.getAttribute('data-participante-nombre');
          
          participanteIdInput.value = participanteId;
          nombreParticipanteSpan.textContent = participanteNombre;
          
          // Resetear el formulario
          document.querySelector('form').reset();
          puntuacionTotalSpan.textContent = '0';
          
          // Resetear el estado visual de los botones de flechas
          btnsFlechas.forEach(btn => {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
            const valorBadge = btn.querySelector('.valor-flecha');
            valorBadge.textContent = '-';
            valorBadge.classList.add('d-none');
          });
          
          // Ocultar la botonera si estaba visible
          botoneraContainer.classList.add('d-none');
          
          // Mostrar el formulario con animación
          registroForm.style.display = 'block';
          // Forzar un reflow para que la transición funcione
          registroForm.offsetHeight;
          registroForm.classList.add('show');
          
          // Desplazar suavemente hacia el formulario
          setTimeout(() => {
            registroForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
          
          // Resaltar la fila seleccionada
          participanteRows.forEach(row => {
            row.classList.remove('table-info');
          });
          this.closest('tr, .list-group-item').classList.add('table-info');
        });
      });
    }
    
    // Ocultar formulario al cancelar
    if (cancelarBtn) {
      cancelarBtn.addEventListener('click', function() {
        registroForm.classList.remove('show');
        setTimeout(() => {
          registroForm.style.display = 'none';
          // Desplazar suavemente hacia arriba
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 300);
        
        // Quitar resaltado de filas
        participanteRows.forEach(row => {
          row.classList.remove('table-info');
        });
      });
    }

    // Manejar el envío del formulario
    const form = document.querySelector('form.needs-validation');
    if (form) {
      form.addEventListener('submit', function(event) {
        if (!this.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        } else {
          // Si el formulario es válido, desplazar hacia arriba antes de enviar
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        this.classList.add('was-validated');
      });
    }
    
    // Inicializar la interfaz móvil
    if (prevFlechaBtn && nextFlechaBtn) {
      actualizarNavegacionFlechas();
      
      // Manejar navegación entre flechas
      prevFlechaBtn.addEventListener('click', function() {
        if (flechaActivaIdx > 0) {
          flechaActivaIdx--;
          actualizarNavegacionFlechas();
        }
      });
      
      nextFlechaBtn.addEventListener('click', function() {
        if (flechaActivaIdx < <%= torneo.flechasPorTirada - 1 %>) {
          flechaActivaIdx++;
          actualizarNavegacionFlechas();
        }
      });
      
      // Manejar clic en indicadores de flecha
      flechaIndicators.forEach((indicator, idx) => {
        indicator.addEventListener('click', function() {
          flechaActivaIdx = idx;
          actualizarNavegacionFlechas();
        });
      });
      
      // Manejar selección de puntos en móvil
      puntoBtnsMobile.forEach(btn => {
        btn.addEventListener('click', function() {
          const punto = this.getAttribute('data-punto');
          const flechaInput = document.getElementById(`puntoInput${flechaActivaIdx}`);
          
          // Actualizar el valor del input
          flechaInput.value = punto;
          
          // Actualizar visualmente el valor en móvil
          valorFlechaMobile.textContent = punto;
          
          // Establecer el color del valor según el punto
          valorFlechaMobile.className = 'display-1 fw-bold';
          if (punto <= 2) {
            valorFlechaMobile.classList.add('text-dark');
          } else if (punto <= 4) {
            valorFlechaMobile.classList.add('text-dark');
          } else if (punto <= 6) {
            valorFlechaMobile.classList.add('text-info');
          } else if (punto <= 8) {
            valorFlechaMobile.classList.add('text-danger');
          } else {
            valorFlechaMobile.classList.add('text-warning');
          }
          
          // Actualizar el indicador de flecha
          actualizarIndicadorFlecha(flechaActivaIdx, punto);
          
          // Actualizar el resumen
          actualizarResumenFlecha(flechaActivaIdx, punto);
          
          // Calcular el total
          calcularTotal();
          
          // Avanzar automáticamente a la siguiente flecha si no es la última
          if (flechaActivaIdx < <%= torneo.flechasPorTirada - 1 %>) {
            setTimeout(() => {
              flechaActivaIdx++;
              actualizarNavegacionFlechas();
            }, 300);
          }
        });
      });
    }
    
    // Función para actualizar la navegación de flechas en móvil
    function actualizarNavegacionFlechas() {
      // Actualizar texto de flecha actual
      flechaActualMobile.textContent = flechaActivaIdx + 1;
      
      // Actualizar estado de botones de navegación
      prevFlechaBtn.disabled = flechaActivaIdx === 0;
      nextFlechaBtn.disabled = flechaActivaIdx === <%= torneo.flechasPorTirada - 1 %>;
      
      // Actualizar indicadores de flecha
      flechaIndicators.forEach((indicator, idx) => {
        const badge = indicator.querySelector('.badge');
        if (idx === flechaActivaIdx) {
          badge.classList.remove('bg-secondary');
          badge.classList.add('bg-primary');
        } else {
          const input = document.getElementById(`puntoInput${idx}`);
          if (input.value !== '') {
            badge.classList.remove('bg-secondary', 'bg-primary');
            badge.classList.add('bg-success');
          } else {
            badge.classList.remove('bg-primary', 'bg-success');
            badge.classList.add('bg-secondary');
          }
        }
      });
      
      // Mostrar el valor actual si existe
      const valorActual = document.getElementById(`puntoInput${flechaActivaIdx}`).value;
      if (valorActual !== '') {
        valorFlechaMobile.textContent = valorActual;
        
        // Establecer el color según el valor
        valorFlechaMobile.className = 'display-1 fw-bold';
        if (valorActual <= 2) {
          valorFlechaMobile.classList.add('text-dark');
        } else if (valorActual <= 4) {
          valorFlechaMobile.classList.add('text-dark');
        } else if (valorActual <= 6) {
          valorFlechaMobile.classList.add('text-info');
        } else if (valorActual <= 8) {
          valorFlechaMobile.classList.add('text-danger');
        } else {
          valorFlechaMobile.classList.add('text-warning');
        }
      } else {
        valorFlechaMobile.textContent = '-';
        valorFlechaMobile.className = 'display-1 fw-bold';
      }
    }
    
    // Función para actualizar el indicador de flecha
    function actualizarIndicadorFlecha(idx, valor) {
      const indicator = flechaIndicators[idx];
      const badge = indicator.querySelector('.badge');
      badge.classList.remove('bg-secondary', 'bg-primary');
      badge.classList.add('bg-success');
    }
    
    // Función para actualizar el resumen de flecha
    function actualizarResumenFlecha(idx, valor) {
      const resumen = resumenFlechas[idx];
      resumen.textContent = valor;
      
      // Establecer el color según el valor
      resumen.className = 'badge p-2';
      if (valor <= 2) {
        resumen.classList.add('bg-light', 'text-dark', 'border');
      } else if (valor <= 4) {
        resumen.classList.add('bg-dark', 'text-white');
      } else if (valor <= 6) {
        resumen.classList.add('bg-info', 'text-dark');
      } else if (valor <= 8) {
        resumen.classList.add('bg-danger', 'text-dark');
      } else {
        resumen.classList.add('bg-warning', 'text-dark');
      }
    }
    
    // Calcular el total de la puntuación
    function calcularTotal() {
      let total = 0;
      puntuacionInputs.forEach((input, idx) => {
        if (input.value !== '') {
          total += parseInt(input.value);
          actualizarResumenFlecha(idx, input.value);
        }
      });
      puntuacionTotalSpan.textContent = total;
    }
  });
</script>

<style>
  /* Estilos para la nueva botonera */
  .btn-flecha {
    position: relative;
    min-height: 50px;
    border-width: 2px;
    transition: all 0.2s ease;
  }
  
  .btn-flecha.active {
    transform: scale(1.05);
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
  }
  
  .btn-flecha.btn-success {
    border-color: #146c43;
  }
  
  .btn-flecha.btn-outline-danger {
    border-width: 2px;
    animation: pulse-danger 2s infinite;
  }
  
  @keyframes pulse-danger {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
  }
  
  .valor-flecha {
    position: absolute;
    top: -10px;
    right: -10px;
    font-size: 14px;
    font-weight: bold;
    min-width: 26px;
    height: 26px;
    line-height: 19px;
    border-radius: 50%;
    z-index: 2;
  }
  
  .punto-btn, .punto-btn-mobile {
    font-size: 1.4rem;
    font-weight: bold;
    min-height: 60px;
    transition: all 0.15s ease;
  }
  
  .punto-btn:active, .punto-btn-mobile:active {
    transform: scale(0.95);
  }
  
  #botoneraContainer {
    animation: fadeIn 0.3s ease;
  }
  
  .flecha-indicator {
    cursor: pointer;
  }
  
  .flecha-indicator .badge {
    width: 30px;
    height: 30px;
    line-height: 22px;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  .botonera-mobile {
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Estilos para la lista de participantes en móvil */
  @media (max-width: 767.98px) {
    /* Ajustes generales para móvil */
    body {
      overflow-x: hidden;
    }
    
    .container {
      padding-left: 0;
      padding-right: 0;
      max-width: 100%;
    }
    
    .row {
      margin-left: 0;
      margin-right: 0;
    }
    
    .col-12 {
      padding-left: 0;
      padding-right: 0;
    }
    
    /* Estilo para el formulario de registro */
    #registroTiradaForm {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #registroTiradaForm.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    
    #registroTiradaForm .card {
      border-radius: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    
    #registroTiradaForm .card-header {
      border-radius: 0.5rem 0.5rem 0 0;
      padding: 1rem;
    }
    
    #registroTiradaForm .card-body {
      padding: 1rem;
    }
    
    /* Ajustes para el selector de flechas y puntuación */
    .botonera-mobile {
      background: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    
    /* Estilo para el botón de guardar */
    #registroTiradaForm .btn-success.btn-lg {
      position: sticky;
      bottom: 1rem;
      width: 100%;
      height: 3.5rem;
      border-radius: 0.5rem;
      font-size: 1.2rem;
      margin-top: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Ajustes para el resumen de puntuación */
    #registroTiradaForm .card:not(:first-child) {
      margin: 1rem 0;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Estilo para los botones de puntuación */
    .punto-btn-mobile {
      height: 3.5rem;
      font-size: 1.3rem;
      font-weight: bold;
      border-radius: 0.5rem;
    }
    
    /* Navegación de flechas */
    #prevFlechaBtn, #nextFlechaBtn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #valorFlechaMobile {
      font-size: 5rem;
      line-height: 1;
      margin: 1.5rem 0;
    }
    
    .flecha-indicator .badge {
      width: 2.5rem;
      height: 2.5rem;
      line-height: 1.8rem;
      font-size: 1.1rem;
    }
  }
</style> 